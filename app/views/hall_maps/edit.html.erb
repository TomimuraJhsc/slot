<link rel="stylesheet" href="/stylesheets/hall_map.css">

<style>
    .auto-increment-options {
        display: flex;
        gap: 10px;
        margin-top: 8px;
    }

    .radio-option {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        border: 2px solid #ddd;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        background: white;
    }

    .radio-option:hover {
        border-color: #0066cc;
        background: #f0f7ff;
    }

    .radio-option input[type="radio"] {
        margin-right: 6px;
        cursor: pointer;
    }

    .radio-option input[type="radio"]:checked+span {
        font-weight: bold;
        color: #0066cc;
    }

    .radio-option:has(input[type="radio"]:checked) {
        border-color: #0066cc;
        background: #e3f2fd;
    }
</style>

<div class="map-editor-container" data-hall-id="<%= @hall.id %>" data-map-id="<%= @map.id %>">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="editor-header">
        <div class="editor-title">
            <h1>âœï¸ ãƒãƒƒãƒ—ç·¨é›†: <%= @map.name %></h1>
            <span class="map-info">ğŸ“ <%= @map.rows %>è¡Œ Ã— <%= @map.cols %>åˆ—</span>
        </div>
        <div class="editor-actions">
            <%= link_to "â† ãƒãƒƒãƒ—ä¸€è¦§", hall_maps_path(@hall), class: "btn-secondary" %>
            <button onclick="saveMapData()" class="btn-success" id="save-btn">
                ğŸ’¾ ä¿å­˜
            </button>
        </div>
    </div>

    <!-- ãƒ„ãƒ¼ãƒ«ãƒ‘ãƒ¬ãƒƒãƒˆ -->
    <div class="tool-palette">
        <h3>ğŸ› ï¸ ãƒ„ãƒ¼ãƒ«</h3>
        <div class="tool-buttons">
            <button class="tool-btn active" data-tool="machine" onclick="selectTool('machine')">
                ğŸ° å°ã‚’é…ç½®
            </button>
            <button class="tool-btn" data-tool="wall" onclick="selectTool('wall')">
                ğŸ§± å£
            </button>
            <button class="tool-btn" data-tool="counter" onclick="selectTool('counter')">
                ğŸª ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
            </button>
            <button class="tool-btn" data-tool="empty" onclick="selectTool('empty')">
                â¬œ ç©ºç™½
            </button>
            <button class="tool-btn" data-tool="eraser" onclick="selectTool('eraser')">
                ğŸ—‘ï¸ æ¶ˆã—ã‚´ãƒ 
            </button>
        </div>

        <!-- å°ç•ªå·å…¥åŠ› -->
        <div id="machine-input-panel" class="input-panel">
            <label class="input-label">å°ç•ªå·:</label>
            <input type="number" id="machine-number-input" placeholder="ä¾‹: 101" class="tool-input">
            <button onclick="applyMachineNumber()" class="btn-apply">é©ç”¨</button>

            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                <label class="input-label">è‡ªå‹•å¢—æ¸›:</label>
                <div class="auto-increment-options">
                    <label class="radio-option">
                        <input type="radio" name="auto-increment" value="0" checked>
                        <span>ãªã—</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="auto-increment" value="1">
                        <span>+1</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="auto-increment" value="-1">
                        <span>-1</span>
                    </label>
                </div>
                <small style="display: block; margin-top: 5px; color: #666; font-size: 12px;">
                    ã‚»ãƒ«ã‚¯ãƒªãƒƒã‚¯æ™‚ã«å°ç•ªå·ã‚’è‡ªå‹•ã§è¨­å®šã—ã€è¨­å®šå€¤ã‚’å¢—æ¸›ã—ã¾ã™
                </small>
            </div>
        </div>

        <!-- ãƒ©ãƒ™ãƒ«å…¥åŠ› -->
        <div id="label-input-panel" class="input-panel" style="display: none;">
            <label class="input-label">ãƒ©ãƒ™ãƒ«:</label>
            <input type="text" id="label-input" placeholder="ä¾‹: ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼" class="tool-input">
        </div>

        <!-- é¸æŠæƒ…å ± -->
        <div class="selection-info">
            <h4>é¸æŠä¸­ã®ã‚»ãƒ«</h4>
            <div id="selection-display">ãªã—</div>
        </div>

        <!-- ã‚ºãƒ¼ãƒ æ“ä½œ -->
        <div style="border-top: 2px solid #ddd; padding-top: 15px; margin-top: 15px;">
            <h4 style="margin: 0 0 10px 0;">ğŸ” ã‚ºãƒ¼ãƒ </h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                <button onclick="zoomIn()" class="control-btn">æ‹¡å¤§</button>
                <button onclick="zoomOut()" class="control-btn">ç¸®å°</button>
            </div>
            <button onclick="resetZoom()" class="control-btn" style="width: 100%; margin-top: 5px;">â†º ãƒªã‚»ãƒƒãƒˆ</button>
        </div>

        <!-- è¡Œãƒ»åˆ—ã®ç·¨é›† -->
        <div style="border-top: 2px solid #ddd; padding-top: 15px; margin-top: 15px;">
            <h4 style="margin: 0 0 10px 0;">ğŸ“ è¡Œãƒ»åˆ—ã®ç·¨é›†</h4>
            <div style="font-size: 11px; color: #666; margin-bottom: 10px;">
                ã‚»ãƒ«ã‚’é¸æŠã—ã¦ã‹ã‚‰æ“ä½œã—ã¦ãã ã•ã„
            </div>

            <div style="margin-bottom: 15px;">
                <strong style="display: block; margin-bottom: 5px; font-size: 13px;">â¬†ï¸â¬‡ï¸ è¡Œ</strong>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                    <button onclick="addRowAtSelection('above')" class="control-btn" style="font-size: 11px;">â†‘ ä¸Šã«è¿½åŠ </button>
                    <button onclick="addRowAtSelection('below')" class="control-btn" style="font-size: 11px;">â†“ ä¸‹ã«è¿½åŠ </button>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 5px;">
                    <button onclick="removeRowAtSelection('current')" class="control-btn" style="font-size: 11px; background: #ff6b6b; color: white;">âœ• ã“ã®è¡Œã‚’å‰Šé™¤</button>
                    <button onclick="removeRowAtSelection('below')" class="control-btn" style="font-size: 11px; background: #ff8787; color: white;">â†“ ä¸‹ã‚’å‰Šé™¤</button>
                </div>
            </div>

            <div>
                <strong style="display: block; margin-bottom: 5px; font-size: 13px;">â¬…ï¸â¡ï¸ åˆ—</strong>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                    <button onclick="addColumnAtSelection('left')" class="control-btn" style="font-size: 11px;">â† å·¦ã«è¿½åŠ </button>
                    <button onclick="addColumnAtSelection('right')" class="control-btn" style="font-size: 11px;">â†’ å³ã«è¿½åŠ </button>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 5px;">
                    <button onclick="removeColumnAtSelection('current')" class="control-btn" style="font-size: 11px; background: #ff6b6b; color: white;">âœ• ã“ã®åˆ—ã‚’å‰Šé™¤</button>
                    <button onclick="removeColumnAtSelection('right')" class="control-btn" style="font-size: 11px; background: #ff8787; color: white;">â†’ å³ã‚’å‰Šé™¤</button>
                </div>
            </div>

            <div style="margin-top: 10px; font-size: 10px; color: #999; line-height: 1.3;">
                âš ï¸ å‰Šé™¤ã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“
            </div>
        </div>

        <!-- æ“ä½œã‚¬ã‚¤ãƒ‰ -->
        <div class="operation-guide">
            <h4>ğŸ“– æ“ä½œæ–¹æ³•</h4>
            <ul>
                <li>ğŸ° å°é…ç½®: å°ç•ªå·å…¥åŠ›â†’ã‚»ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                <li>âš¡ é€£ç¶šå…¥åŠ›: è‡ªå‹•å¢—æ¸›ã‚’é¸æŠã—ã¦ã‚¯ãƒªãƒƒã‚¯é€£æ‰“</li>
                <li>ğŸ§± å£/ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼: ãƒ„ãƒ¼ãƒ«é¸æŠâ†’ã‚»ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                <li>ğŸ“ è¡Œåˆ—ç·¨é›†: ã‚»ãƒ«é¸æŠå¾Œã«ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                <li>ğŸ’¾ å®Œäº†ã—ãŸã‚‰ä¿å­˜ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
            </ul>
        </div>
    </div>

    <!-- ãƒãƒƒãƒ—ã‚°ãƒªãƒƒãƒ‰ -->
    <div class="editor-grid-container">
        <div class="grid-scroll-area">
            <table id="editor-map-table" class="editor-map-table">
                <tbody>
                    <% (1..@map.rows).each do |row| %>
                    <tr>
                        <% (1..@map.cols).each do |col| %>
                        <%
                          cell = @map.get_cell(row, col)
                          machine_number = cell['machine_number']
                          cell_type = cell['type'] || 'empty'
                          label = cell['label']
                        %>
                        <td class="editor-cell <%= cell_type %>" data-row="<%= row %>" data-col="<%= col %>" data-type="<%= cell_type %>" data-machine-number="<%= machine_number %>" data-label="<%= label %>" onclick="selectCell(<%= row %>, <%= col %>)">

                            <% if cell_type == 'machine' %>
                            <div class="cell-content">
                                <span class="cell-number"><%= machine_number %></span>
                            </div>

                            <% elsif cell_type == 'wall' %>
                            <div class="cell-content wall">
                                <%= label || 'â– ' %>
                            </div>

                            <% elsif cell_type == 'counter' %>
                            <div class="cell-content counter">
                                <%= label || 'ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼' %>
                            </div>

                            <% end %>
                        </td>
                        <% end %>
                    </tr>
                    <% end %>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆéè¡¨ç¤ºï¼‰ -->
<%= form_with url: hall_map_path(@hall, @map), method: :patch, id: "map-save-form", style: "display: none;" do |f| %>
<%= hidden_field_tag :layout_data, "", id: "layout-data-field" %>
<%= hidden_field_tag "hall_map[rows]", @map.rows, id: "rows-field" %>
<%= hidden_field_tag "hall_map[cols]", @map.cols, id: "cols-field" %>
<% end %>

<!-- ãƒ‡ãƒ¼ã‚¿ä¿æŒç”¨ã®hiddenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
<div id="editor-initial-data" data-hall-id="<%= @hall.id %>" data-map-id="<%= @map.id %>" data-rows="<%= @map.rows %>" data-cols="<%= @map.cols %>" style="display: none;">
    <%= @map.safe_layout_data.to_json %>
</div>

<script src="/javascripts/hall_map_editor.js"></script>