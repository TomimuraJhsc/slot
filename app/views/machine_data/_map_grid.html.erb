<link rel="stylesheet" href="/stylesheets/hall_map.css">
<script src="/javascripts/hall_map.js"></script>

<div class="map-tab-container" data-turbo="false" <% if @current_map %> data-hall-id="<%= @hall.id %>" data-map-id="<%= @current_map.id %>" data-date="<%= @date %>" <% end %>>
    <% if @hall_maps.any? %>
    <!-- ãƒãƒƒãƒ—é¸æŠã¨ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
    <div class="map-toolbar">
        <div class="map-selector">
            <label style="font-weight: bold; margin-right: 10px;">ğŸ—ºï¸ ãƒãƒƒãƒ—é¸æŠ:</label>
            <select id="map-select" onchange="changeMap(this.value)" style="padding: 8px; font-size: 14px;">
                <% @hall_maps.each do |map| %>
                <option value="<%= map.id %>" <%= 'selected' if map.id == @current_map&.id %>>
                    <%= map.name %>
                </option>
                <% end %>
            </select>
        </div>
        <div style="display: flex; gap: 10px;">
            <% if @current_map %>
            <%= link_to "âœï¸ ã“ã®ãƒãƒƒãƒ—ã‚’ç·¨é›†", edit_hall_map_path(@hall, @current_map), 
                    class: "btn-primary", style: "text-decoration: none;", data: { turbo: false } %>
            <% end %>
            <%= link_to "ğŸ“‹ ãƒãƒƒãƒ—ç®¡ç†", hall_maps_path(@hall), 
                    class: "btn-secondary", style: "text-decoration: none;", data: { turbo: false } %>
        </div>
    </div>

    <!-- è‰²åˆ†ã‘è¨­å®šãƒ‘ãƒãƒ« -->
    <%= render 'color_settings' %>

    <!-- è¡¨ç¤ºè¨­å®šãƒ‘ãƒãƒ« -->
    <%= render 'display_settings' %>

    <!-- ãƒãƒƒãƒ—ã‚°ãƒªãƒƒãƒ‰ -->
    <% if @current_map %>

    <div class="map-grid-container">
        <table id="map-table" class="map-table">
            <tbody>
                <% (1..@current_map.rows).each do |row| %>
                <tr>
                    <% (1..@current_map.cols).each do |col| %>
                    <%
                              cell = @current_map.get_cell(row, col)
                              machine_number = cell['machine_number']
                              cell_type = cell['type'] || 'empty'
                              label = cell['label']
                              machine = @machine_data_by_number[machine_number] if machine_number
                              worst_rank = machine_number && @color_worst_ranks ? @color_worst_ranks[machine_number] : nil
                            %>
                    <td class="map-cell <%= cell_type %>" data-row="<%= row %>" data-col="<%= col %>" data-type="<%= cell_type %>" data-machine-number="<%= machine_number %>" <% if worst_rank %>data-worst-rank="<%= worst_rank %>" <% end %>>

                        <% if cell_type == 'machine' && machine %>
                        <div class="cell-content machine" data-machine-number="<%= machine.machine_number %>" data-difference="<%= machine.difference_count %>" data-games="<%= machine.game_count %>" <% if worst_rank %>data-worst-rank="<%= worst_rank %>" <% end %> title="<%= machine.machine_name %>">
                            <div class="machine-info">
                                <div class="machine-number"><%= machine.machine_number %></div>
                                <div class="machine-name"><%= machine.machine_name.truncate(5, omission: '') %></div>
                                <div class="machine-stats">
                                    <div class="stat difference">å·®æš: <%= machine.difference_count %></div>
                                    <div class="stat games">Gæ•°: <%= machine.game_count %></div>
                                </div>
                            </div>
                        </div>

                        <% elsif cell_type == 'wall' %>
                        <div class="cell-content wall">
                            <%= label || 'â– ' %>
                        </div>

                        <% elsif cell_type == 'counter' %>
                        <div class="cell-content counter">
                            <%= label || 'ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼' %>
                        </div>

                        <% end %>
                    </td>
                    <% end %>
                </tr>
                <% end %>
            </tbody>
        </table>
    </div>
    <% end %>

    <% else %>
    <!-- ãƒãƒƒãƒ—æœªä½œæˆæ™‚ -->
    <div class="no-map-message">
        <div style="text-align: center; padding: 60px 20px;">
            <h2 style="color: #666; margin-bottom: 20px;">ğŸ—ºï¸ ãƒãƒƒãƒ—ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“</h2>
            <p style="color: #888; margin-bottom: 30px;">
                åº—å†…ã®é…ç½®å›³ã‚’ä½œæˆã™ã‚‹ã¨ã€å°ã®ä½ç½®ã¨å®Ÿç¸¾ã‚’è¦–è¦šçš„ã«ç¢ºèªã§ãã¾ã™ã€‚
            </p>
            <%= link_to "æ–°è¦ãƒãƒƒãƒ—ã‚’ä½œæˆ", new_hall_map_path(@hall), 
                    class: "btn-primary", 
                    style: "font-size: 16px; padding: 12px 30px; text-decoration: none; display: inline-block;",
                    data: { turbo: false } %>
        </div>
    </div>
    <% end %>
</div>