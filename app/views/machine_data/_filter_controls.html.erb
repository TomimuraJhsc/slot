<%
  # „Éá„Éï„Ç©„É´„ÉàÂÄ§„ÇíË®≠ÂÆö
  panel_id ||= 'filter-content'
%>

<div class="filter-controls collapsible-panel">
    <div class="collapsible-header" onclick="togglePanel('<%= panel_id %>')">
        <h3>üîç „Éï„Ç£„É´„Çø„Éº</h3>
        <span class="collapsible-toggle">‚ñº</span>
    </div>
    <div id="<%= panel_id %>" class="collapsible-content">
        <div class="collapsible-inner">
            <form id="filter-form" method="get">
                <!-- hall_id„Å®date„Çí‰øùÊåÅ -->
                <input type="hidden" name="hall_id" value="<%= params[:hall_id] %>">
                <input type="hidden" id="active-tab" name="active_tab" value="<%= params[:active_tab] || 'list' %>">

                <!-- Ë°®Á§∫Êó•Êï∞„Éë„É©„É°„Éº„Çø„Çí‰øùÊåÅ -->
                <% @display_days.each do |day| %>
                <input type="hidden" name="display_days[]" value="<%= day %>">
                <% end %>

                <!-- Êó•Âà•ÈõÜË®à„Çø„Éñ„ÅÆ„Éë„É©„É°„Éº„Çø„Çí‰øùÊåÅ -->
                <% if params[:date_range].present? %>
                <input type="hidden" name="date_range" value="<%= params[:date_range] %>">
                <% end %>
                <% if params[:custom_dates].present? %>
                <% params[:custom_dates].each do |custom_date| %>
                <input type="hidden" name="custom_dates[]" value="<%= custom_date %>">
                <% end %>
                <% end %>

                <!-- „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Çø„Éñ„Çí‰øùÊåÅ -->
                <input type="hidden" id="active-tab" name="active_tab" value="<%= params[:active_tab] || 'list' %>">

                <!-- Êó•‰ªòÈÅ∏Êäû -->
                <div class="filter-row" style="border-bottom: 2px solid #0066cc; padding-bottom: 15px; margin-bottom: 15px;">
                    <div class="filter-group">
                        <label>üìÖ Êó•‰ªò:</label>
                        <input type="date" id="date-input" name="date" value="<%= @date %>" required style="padding: 6px 8px; font-size: 14px; border-radius: 6px; border: 1px solid #ccc;" onchange="changeDate(this.value, <%= params[:hall_id] %>)">

                        <!-- Êó•‰ªò„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
                        <div style="margin-top: 10px; display: flex; gap: 8px; align-items: center;">
                            <% prev_date = @date - 1.day %>
                            <% next_date = @date + 1.day %>

                            <a href="<%= url_for(action: 'show', hall_id: params[:hall_id], date: prev_date, sort_by: @sort_by, sort_order: @sort_order, display_days: @display_days) %>" class="btn-nav" style="padding: 5px 10px; text-decoration: none; background-color: #10b981; color: white; border-radius: 6px; cursor: pointer; font-size: 13px;">
                                ‚óÄ ÂâçÊó•
                            </a>

                            <span style="color: #666; font-size: 13px; min-width: 120px; text-align: center;">
                                <%= @date.strftime('%YÂπ¥%mÊúà%dÊó•') %>
                            </span>

                            <a href="<%= url_for(action: 'show', hall_id: params[:hall_id], date: next_date, sort_by: @sort_by, sort_order: @sort_order, display_days: @display_days) %>" class="btn-nav" style="padding: 5px 10px; text-decoration: none; background-color: #10b981; color: white; border-radius: 6px; cursor: pointer; font-size: 13px;">
                                ÁøåÊó• ‚ñ∂
                            </a>

                            <a href="<%= url_for(action: 'show', hall_id: params[:hall_id], date: Date.today, sort_by: @sort_by, sort_order: @sort_order, display_days: @display_days) %>" class="btn-nav" style="padding: 5px 10px; text-decoration: none; background-color: #059669; color: white; border-radius: 6px; cursor: pointer; font-size: 13px;">
                                üìç ‰ªäÊó•
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Ê©üÁ®ÆÂêç„Éï„Ç£„É´„Çø„ÉºÔºà„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥Ôºâ -->
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Ê©üÁ®ÆÂêç:</label>
                        <select name="filter_machine_name" style="border-radius: 6px; padding: 6px 8px;">
                            <option value="">--„Åô„Åπ„Å¶--</option>
                            <% @machine_names.each do |name| %>
                            <option value="<%= name %>" <%= 'selected' if @filter_machine_name == name %>>
                                <%= name %>
                            </option>
                            <% end %>
                        </select>
                    </div>
                </div>

                <!-- Ê©üÁ®ÆÂêçÊ§úÁ¥¢„Éï„Ç£„É´„Çø„Éº -->
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Ê©üÁ®ÆÂêçÊ§úÁ¥¢:</label>
                        <input type="text" name="filter_machine_name_search" placeholder="Ê§úÁ¥¢„ÉØ„Éº„ÉâÂÖ•Âäõ" value="<%= @filter_machine_name_search %>" style="width: 150px; border-radius: 6px; padding: 6px 8px;">
                        <select name="filter_machine_name_search_type" style="width: auto; border-radius: 6px; padding: 6px 8px;">
                            <option value="include" <%= 'selected' if @filter_machine_name_search_type == 'include' %>>Âê´„ÇÄ</option>
                            <option value="exclude" <%= 'selected' if @filter_machine_name_search_type == 'exclude' %>>Âê´„Åæ„Å™„ÅÑ</option>
                        </select>
                    </div>
                </div>

                <!-- GÊï∞„Éï„Ç£„É´„Çø„Éº -->
                <div class="filter-row">
                    <div class="filter-group">
                        <label>GÊï∞:</label>
                        <input type="number" name="filter_game_count_min" placeholder="ÊúÄÂ∞è" value="<%= @filter_game_count_min %>">
                        <span>ÔΩû</span>
                        <input type="number" name="filter_game_count_max" placeholder="ÊúÄÂ§ß" value="<%= @filter_game_count_max %>">
                    </div>
                </div>

                <!-- ÂΩìÊó•Â∑ÆÊûö„Éï„Ç£„É´„Çø„Éº -->
                <div class="filter-row">
                    <div class="filter-group">
                        <label>ÂΩìÊó•Â∑ÆÊûö:</label>
                        <input type="number" name="filter_difference_min" placeholder="ÊúÄÂ∞è" value="<%= @filter_difference_min %>">
                        <span>ÔΩû</span>
                        <input type="number" name="filter_difference_max" placeholder="ÊúÄÂ§ß" value="<%= @filter_difference_max %>">
                    </div>
                </div>

                <!-- BBÊï∞„Éï„Ç£„É´„Çø„Éº -->
                <div class="filter-row">
                    <div class="filter-group">
                        <label>BBÊï∞:</label>
                        <input type="number" name="filter_bb_count_min" placeholder="ÊúÄÂ∞è" value="<%= @filter_bb_count_min %>">
                        <span>ÔΩû</span>
                        <input type="number" name="filter_bb_count_max" placeholder="ÊúÄÂ§ß" value="<%= @filter_bb_count_max %>">
                    </div>
                </div>

                <!-- ÈÅéÂéªNÊó•Â∑ÆÊûö„Éï„Ç£„É´„Çø„Éº -->
                <div class="filter-row">
                    <div class="filter-group">
                        <label>ÈÅéÂéª</label>
                        <select name="filter_diff_days">
                            <option value="">--Êó•Êï∞ÈÅ∏Êäû--</option>
                            <% (1..31).each do |days| %>
                            <option value="<%= days %>" <%= 'selected' if @filter_diff_days == days %>>
                                <%= days %>Êó•
                            </option>
                            <% end %>
                        </select>
                        <label>„ÅÆÂ∑ÆÊûö:</label>
                        <input type="number" name="filter_diff_value_min" placeholder="ÊúÄÂ∞è" value="<%= @filter_diff_value_min %>">
                        <span>ÔΩû</span>
                        <input type="number" name="filter_diff_value_max" placeholder="ÊúÄÂ§ß" value="<%= @filter_diff_value_max %>">
                    </div>
                </div>

                <!-- ÈÅéÂéªNÊó•ÂõûËª¢Êï∞„Éï„Ç£„É´„Çø„Éº -->
                <div class="filter-row">
                    <div class="filter-group">
                        <label>ÈÅéÂéª</label>
                        <select name="filter_game_count_days">
                            <option value="">--Êó•Êï∞ÈÅ∏Êäû--</option>
                            <% (1..31).each do |days| %>
                            <option value="<%= days %>" <%= 'selected' if @filter_game_count_days == days %>>
                                <%= days %>Êó•
                            </option>
                            <% end %>
                        </select>
                        <label>„ÅÆÂõûËª¢Êï∞:</label>
                        <input type="number" name="filter_game_count_value_min" placeholder="ÊúÄÂ∞è" value="<%= @filter_game_count_value_min %>">
                        <span>ÔΩû</span>
                        <input type="number" name="filter_game_count_value_max" placeholder="ÊúÄÂ§ß" value="<%= @filter_game_count_value_max %>">
                    </div>
                </div>

                <!-- Ê©üÁ®ÆÊØéÂè∞Êï∞„Éï„Ç£„É´„Çø„Éº -->
                <div class="filter-row" style="border-top: 2px dashed #0066cc; padding-top: 15px; margin-top: 15px;">
                    <div class="filter-group">
                        <label>Ê©üÁ®ÆÊØéÂè∞Êï∞:</label>
                        <input type="number" name="filter_machine_count_min" placeholder="ÊúÄÂ∞è" value="<%= @filter_machine_count_min %>" min="0">
                        <span>ÔΩû</span>
                        <input type="number" name="filter_machine_count_max" placeholder="ÊúÄÂ§ß" value="<%= @filter_machine_count_max %>" min="0">
                    </div>
                    <div class="filter-group" style="font-size: 12px; color: #666; margin-left: 10px;">
                        <p style="margin: 0;">Ôºà„ÄáÂè∞‰ª•‰∏ä„ÅÆ„ÅøË°®Á§∫„ÄÅ„Åæ„Åü„ÅØ‚ñ≥Âè∞‰ª•‰∏ã„ÇíÈô§Â§ñÔºâ</p>
                    </div>
                </div>

                <!-- Ê©üÁ®ÆÊØé„ÉØ„Éº„Çπ„Éà„É©„É≥„Ç≠„É≥„Ç∞„Éï„Ç£„É´„Çø„Éº -->
                <div class="filter-row" style="border-top: 2px dashed #0066cc; padding-top: 15px; margin-top: 15px;">
                    <div class="filter-group" style="flex-direction: column; align-items: flex-start; gap: 10px;">
                        <label style="color: #0066cc; font-weight: bold;">üèÜ Ê©üÁ®ÆÊØé„ÉØ„Éº„Çπ„ÉàÂè∞Áµû„ÇäËæº„Åø:</label>
                        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <label>ÈÅéÂéª</label>
                                <select name="filter_rank_days">
                                    <option value="">--Êó•Êï∞ÈÅ∏Êäû--</option>
                                    <% (1..31).each do |days| %>
                                    <option value="<%= days %>" <%= 'selected' if params[:filter_rank_days].to_i == days %>>
                                        <%= days %>Êó•
                                    </option>
                                    <% end %>
                                </select>
                                <label>„ÅÆÂ∑ÆÊûö„ÅßÁµû„ÇäËæº„Åø</label>
                            </div>
                            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                <div class="rank-checkbox-group">
                                    <input type="checkbox" id="rank-1" name="filter_ranks[]" value="1" <%= 'checked' if params[:filter_ranks]&.include?('1') %>>
                                    <label for="rank-1" style="color: #ff6b6b; font-weight: bold;">
                                        „ÉØ„Éº„Çπ„Éà1‰Ωç
                                    </label>
                                </div>
                                <div class="rank-checkbox-group">
                                    <input type="checkbox" id="rank-2" name="filter_ranks[]" value="2" <%= 'checked' if params[:filter_ranks]&.include?('2') %>>
                                    <label for="rank-2" style="color: #ffb3b3; font-weight: bold;">
                                        „ÉØ„Éº„Çπ„Éà2‰Ωç
                                    </label>
                                </div>
                                <div class="rank-checkbox-group">
                                    <input type="checkbox" id="rank-3" name="filter_ranks[]" value="3" <%= 'checked' if params[:filter_ranks]&.include?('3') %>>
                                    <label for="rank-3" style="color: #66cc66; font-weight: bold;">
                                        „ÉØ„Éº„Çπ„Éà3‰Ωç
                                    </label>
                                </div>
                                <div class="rank-checkbox-group">
                                    <input type="checkbox" id="rank-4" name="filter_ranks[]" value="4" <%= 'checked' if params[:filter_ranks]&.include?('4') %>>
                                    <label for="rank-4" style="color: #b3e6b3; font-weight: bold;">
                                        „ÉØ„Éº„Çπ„Éà4‰Ωç
                                    </label>
                                </div>
                                <div class="rank-checkbox-group">
                                    <input type="checkbox" id="rank-5" name="filter_ranks[]" value="5" <%= 'checked' if params[:filter_ranks]&.include?('5') %>>
                                    <label for="rank-5" style="color: #999; font-weight: bold;">
                                        „ÉØ„Éº„Çπ„Éà5‰Ωç
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ë°®Á§∫„Åô„ÇãÈÅéÂéª„Éá„Éº„Çø„ÅÆË®≠ÂÆö„Éë„Éç„É´ -->
                <div class="filter-row" style="border-top: 2px dashed #10b981; padding-top: 15px; margin-top: 15px;">
                    <div class="filter-group" style="flex-direction: column; align-items: flex-start; gap: 10px; width: 100%;">
                        <label style="color: #10b981; font-weight: bold;">üìÖ Ë°®Á§∫„Åô„ÇãÈÅéÂéª„Éá„Éº„Çø„ÅÆË®≠ÂÆö</label>

                        <!-- Ë°®Á§∫„Çø„Ç§„ÉóÈÅ∏Êäû -->
                        <div style="display: flex; gap: 20px; margin-bottom: 10px;">
                            <div class="rank-checkbox-group">
                                <input type="checkbox" id="show-difference" name="show_difference" value="1" <%= 'checked' if params[:show_difference] != '0' %>>
                                <label for="show-difference">ÈÅéÂéªÂ∑ÆÊûö„ÇíË°®Á§∫</label>
                            </div>
                            <div class="rank-checkbox-group">
                                <input type="checkbox" id="show-games" name="show_games" value="1" <%= 'checked' if params[:show_games] == '1' %>>
                                <label for="show-games">ÈÅéÂéªÂõûËª¢Êï∞„ÇíË°®Á§∫</label>
                            </div>
                        </div>

                        <!-- Êó•Êï∞ÈÅ∏Êäû -->
                        <div style="width: 100%;">
                            <label style="font-weight: bold; display: block; margin-bottom: 8px;">Ë°®Á§∫„Åô„ÇãÊó•Êï∞:</label>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 8px; max-height: 150px; overflow-y: auto; padding: 10px; background-color: white; border-radius: 6px; border: 1px solid #ccc;">
                                <% (1..31).each do |day| %>
                                <div class="day-checkbox-group" style="min-width: auto;">
                                    <input type="checkbox" id="day-<%= day %>" name="display_days[]" value="<%= day %>" <%= 'checked' if @display_days.include?(day) %>>
                                    <label for="day-<%= day %>"><%= day %>Êó•</label>
                                </div>
                                <% end %>
                            </div>
                        </div>

                        <!-- „Éó„É™„Çª„ÉÉ„Éà„Éú„Çø„É≥ -->
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                            <button type="button" onclick="selectPreset('7-7')" style="padding: 6px 12px; background-color: #fff8e1; border: 1px solid #ffc107; border-radius: 3px; cursor: pointer;">
                                7Êó•
                            </button>
                            <button type="button" onclick="selectPreset('1-8')" style="padding: 6px 12px; background-color: #fff8e1; border: 1px solid #ffc107; border-radius: 3px; cursor: pointer;">
                                ÈÄ±Âçò‰ΩçÔºà1ÔΩû8Êó•Ôºâ
                            </button>
                            <button type="button" onclick="selectPreset('1-31')" style="padding: 6px 12px; background-color: #fff8e1; border: 1px solid #ffc107; border-radius: 3px; cursor: pointer;">
                                ÂÖ®ÊúüÈñìÔºà1ÔΩû31Êó•Ôºâ
                            </button>
                            <button type="button" onclick="clearAllDays()" style="padding: 6px 12px; background-color: #dc3545; color: white; border: 1px solid #dc3545; border-radius: 3px; cursor: pointer;">
                                „Åô„Åπ„Å¶Ëß£Èô§
                            </button>
                        </div>
                    </div>
                </div>

                <!-- „Éï„Ç£„É´„Çø„Éº„Éú„Çø„É≥ -->
                <div class="filter-row">
                    <div class="filter-buttons">
                        <button type="submit" class="btn-apply" style="padding: 6px 16px; border-radius: 6px;">„Éï„Ç£„É´„Çø„ÉºÈÅ©Áî®</button>
                        <button type="button" class="btn-reset" onclick="resetFilter()" style="padding: 6px 16px; border-radius: 6px; white-space: nowrap;">„É™„Çª„ÉÉ„Éà</button>
                    </div>
                </div>
            </form>

            <!-- „Éï„Ç£„É´„Çø„ÉºÁµêÊûúË°®Á§∫ -->
            <% if params[:filter_machine_name].present? || params[:filter_machine_name_search].present? ||
                    params[:filter_game_count_min].present? || params[:filter_game_count_max].present? || 
                    params[:filter_difference_min].present? || params[:filter_difference_max].present? ||
                    params[:filter_bb_count_min].present? || params[:filter_bb_count_max].present? ||
                    params[:filter_diff_days].present? || params[:filter_game_count_days].present? ||
                    params[:filter_rank_days].present? || params[:filter_machine_count_min].present? || 
                    params[:filter_machine_count_max].present? %>
            <div class="result-info">
                ‚úì „Éï„Ç£„É´„Çø„ÉºÈÅ©Áî®Ê∏à„Åø: <strong><%= @machine_data.length %></strong>Âè∞„ÇíË°®Á§∫‰∏≠
            </div>
            <% end %>
        </div>
    </div>
</div>