<!-- 日付範囲選択 -->
<div class="date-range-selector" style="margin: 20px 0; padding: 10px 15px; background-color: #f8f9fa; border-radius: 5px;">
    <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
        <label style="font-weight: bold;">📅 集計期間の選択方法:</label>
        <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="radio" name="date_selection_mode" value="preset" <%= 'checked' if params[:date_range] != 'custom' %> onchange="toggleDateSelectionMode('preset')" style="margin-right: 5px;">
            プリセット期間から選択
        </label>
        <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="radio" name="date_selection_mode" value="custom" <%= 'checked' if params[:date_range] == 'custom' %> onchange="toggleDateSelectionMode('custom')" style="margin-right: 5px;">
            日付を任意で選択
        </label>

        <!-- プリセット期間選択 -->
        <div id="preset-selector" style="display: flex; align-items: center; gap: 10px; <%= 'display: none;' if params[:date_range] == 'custom' %>">
            <label style="font-weight: bold;">集計期間:</label>
            <select id="date-range-select" onchange="changeDateRange(this.value)" style="padding: 6px 10px; font-size: 14px;">
                <option value="7" <%= 'selected' if params[:date_range] == '7' || params[:date_range].blank? %>>過去7日間</option>
                <option value="14" <%= 'selected' if params[:date_range] == '14' %>>過去14日間</option>
                <option value="30" <%= 'selected' if params[:date_range] == '30' %>>過去30日間</option>
                <option value="60" <%= 'selected' if params[:date_range] == '60' %>>過去60日間</option>
                <option value="day_7" <%= 'selected' if params[:date_range] == 'day_7' %>>7のつく日</option>
                <option value="day_1" <%= 'selected' if params[:date_range] == 'day_1' %>>1のつく日</option>
                <option value="day_8" <%= 'selected' if params[:date_range] == 'day_8' %>>8のつく日</option>
            </select>
        </div>

        <span style="color: #666; font-size: 12px;">※ 現在の検索条件でフィルタリングした台のみで集計</span>
    </div>
</div>

<!-- カスタム日付選択パネル -->
<div id="custom-date-selector" class="collapsible-panel" style="margin-bottom: 20px; <%= params[:date_range] == 'custom' ? '' : 'display: none;' %>">
    <div class="collapsible-header" onclick="togglePanel('custom-date-content')" style="background-color: #6c757d; color: white; cursor: pointer;">
        <h3>📌 表示する日付を選択</h3>
        <span class="collapsible-toggle">▼</span>
    </div>
    <div id="custom-date-content" class="collapsible-content">
        <div class="collapsible-inner" style="background-color: #f8f9fa; padding: 20px;">
            <form id="custom-date-form" method="get">
                <!-- 既存のパラメータを保持 -->
                <input type="hidden" name="hall_id" value="<%= params[:hall_id] %>">
                <input type="hidden" name="date" value="<%= @date %>">
                <input type="hidden" name="date_range" value="custom">
                <input type="hidden" id="active-tab" name="active_tab" value="<%= params[:active_tab] || 'daily-summary' %>">

                <!-- フィルターパラメータ保持 -->
                <% params.each do |key, value| %>
                <% if key.start_with?('filter_', 'display_days', 'sort_') && !key.include?('custom_dates') %>
                <% if value.is_a?(Array) %>
                <% value.each do |v| %>
                <input type="hidden" name="<%= key %>[]" value="<%= v %>">
                <% end %>
                <% else %>
                <input type="hidden" name="<%= key %>" value="<%= value %>">
                <% end %>
                <% end %>
                <% end %>

                <div style="margin-bottom: 15px;">
                    <button type="button" onclick="selectAllDates()" style="padding: 5px 10px; margin-right: 10px;">全選択</button>
                    <button type="button" onclick="clearAllDates()" style="padding: 5px 10px; margin-right: 10px;">全解除</button>
                    <button type="submit" style="padding: 5px 15px; background-color: #0066cc; color: white; border: none; border-radius: 3px; cursor: pointer;">選択した日付で表示</button>
                </div>

                <div style="max-height: 400px; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;">
                    <% 
                      selected_dates = params[:custom_dates] || []
                      # 現在の日付から前後1ヶ月の範囲を設定
                      end_date = @date + 1.month
                      start_date = @date - 1.month
                      # データが存在する日付のみを取得
                      available_dates = @hall.machine_data.where(date: start_date..end_date).select(:date).distinct.order(date: :desc).pluck(:date)
                    %>
                    <% available_dates.each do |date| %>
                    <label style="display: flex; align-items: center; padding: 5px;">
                        <input type="checkbox" name="custom_dates[]" value="<%= date %>" class="custom-date-checkbox" <%= 'checked' if selected_dates.include?(date.to_s) %> style="margin-right: 5px;">
                        <%= date.strftime('%Y/%m/%d') %>
                        <span style="font-size: 11px; color: #666; margin-left: 3px;">(<%= %w[日 月 火 水 木 金 土][date.wday] %>)</span>
                    </label>
                    <% end %>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function toggleDateSelectionMode(mode) {
        const presetSelector = document.getElementById('preset-selector');
        const customSelector = document.getElementById('custom-date-selector');

        if (mode === 'custom') {
            presetSelector.style.display = 'none';
            customSelector.style.display = 'block';
        } else {
            presetSelector.style.display = 'block';
            customSelector.style.display = 'none';
        }
    }

    function changeDateRange(value) {
        // プリセット期間選択の場合は即座にリロード
        const url = new URL(window.location.href);
        url.searchParams.set('date_range', value);
        url.searchParams.delete('custom_dates[]');
        url.searchParams.set('active_tab', 'daily-summary');
        window.location.href = url.toString();
    }

    function selectAllDates() {
        const checkboxes = document.querySelectorAll('.custom-date-checkbox');
        checkboxes.forEach(cb => cb.checked = true);
    }

    function clearAllDates() {
        const checkboxes = document.querySelectorAll('.custom-date-checkbox');
        checkboxes.forEach(cb => cb.checked = false);
    }
</script>

<!-- 日別集計テーブル -->
<div style="margin-top: 20px; overflow-x: auto;">
    <% if @daily_summary_data.present? %>
    <table border="1" style="border-collapse: collapse; width: 100%;">
        <thead>
            <tr>
                <th style="padding: 8px; background-color: #d1f5e8;">日付</th>
                <th style="padding: 8px; background-color: #d1f5e8;">総差枚</th>
                <th style="padding: 8px; background-color: #d1f5e8;">勝率</th>
                <th style="padding: 8px; background-color: #d1f5e8;">平均G数</th>
                <th style="padding: 8px; background-color: #d1f5e8;">平均差枚</th>
            </tr>
        </thead>
        <tbody>
            <% @daily_summary_data.each do |day_data| %>
            <tr>
                <td style="padding: 8px; text-align: center;">
                    <a href="<%= url_for(
                        controller: 'machine_data',
                        action: 'show',
                        hall_id: @hall.id,
                        date: day_data[:date],
                        filter_machine_name: params[:filter_machine_name],
                        filter_machine_name_search: params[:filter_machine_name_search],
                        filter_machine_name_search_type: params[:filter_machine_name_search_type],
                        filter_game_count_min: params[:filter_game_count_min],
                        filter_game_count_max: params[:filter_game_count_max],
                        filter_difference_min: params[:filter_difference_min],
                        filter_difference_max: params[:filter_difference_max],
                        filter_bb_count_min: params[:filter_bb_count_min],
                        filter_bb_count_max: params[:filter_bb_count_max],
                        filter_machine_count_min: params[:filter_machine_count_min],
                        filter_machine_count_max: params[:filter_machine_count_max],
                        display_days: @display_days
                    ) %>" style="color: #10b981; text-decoration: none;">
                        <%= day_data[:date].strftime('%Y/%m/%d') %>
                        <span style="font-size: 11px; color: #666;">(<%= %w[日 月 火 水 木 金 土][day_data[:date].wday] %>)</span>
                    </a>
                </td>
                <td style="padding: 8px; text-align: right; <%= day_data[:total_difference] >= 0 ? 'color: #10b981;' : 'color: #dc3545;' %> font-weight: bold;">
                    <%= number_with_delimiter(day_data[:total_difference]) %>
                </td>
                <td style="padding: 8px; text-align: right;">
                    <%= sprintf('%.1f', day_data[:win_rate]) %>%
                    (<%= day_data[:win_count] %>/<%= day_data[:machine_count] %>)
                </td>
                <td style="padding: 8px; text-align: right;"><%= number_with_delimiter(day_data[:avg_games].to_i) %>G</td>
                <td style="padding: 8px; text-align: right; <%= day_data[:avg_difference] >= 0 ? 'color: #10b981;' : 'color: #dc3545;' %>">
                    <%= number_with_delimiter(day_data[:avg_difference].to_i) %>
                </td>
            </tr>
            <% end %>
        </tbody>
    </table>
    <% else %>
    <p style="text-align: center; color: #666; padding: 40px;">データがありません</p>
    <% end %>
</div>